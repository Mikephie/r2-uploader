<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>MyMusic 资产上传</title>
    <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script> 
    
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #uploadForm { display: flex; flex-direction: column; max-width: 450px; gap: 10px; border: 1px solid #007bff; padding: 25px; border-radius: 8px; }
        .file-input { padding: 10px; border: 1px dashed #007bff; border-radius: 4px; }
        .metadata-section { padding: 15px; border: 1px solid #ccc; border-radius: 4px; background-color: #f9f9f9; }
        input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; margin-top: 5px; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 15px; transition: background-color 0.2s; }
        #submitBtn, #submitCoverBtn { background-color: #007bff; color: white; }
        #submitBtn:disabled, #submitCoverBtn:disabled { background-color: #aaa; }
        #linkOutput { margin-top: 10px; padding: 10px; border: 1px solid #00aaff; border-radius: 4px; background-color: #e6f7ff; display: none; }
        #linkOutput a { word-break: break-all; color: #007bff; margin-right: 10px; }
        #copyLinkBtn { background-color: #28a745; color: white; padding: 5px 10px; margin-top: 0; }
        #message { margin-top: 20px; white-space: pre-wrap; background-color: #e6f7ff; padding: 15px; border-radius: 4px; border-left: 5px solid #007bff; }
        #assetListDisplay { border-left: 5px solid #ffc107; background-color: #fffbe6; padding: 15px; /* 增加内边距 */ }
    </style>
</head>
<body>
    <h1>MyMusic 资产上传</h1>
    
    <form id="uploadForm">
        <label for="musicFile">选择音乐文件 (MP3/FLAC/WAV...)</label>
        <input type="file" id="musicFile" accept="audio/*" class="file-input" required>
        
        <label for="coverFile">选择封面图片 (可选，**需单独上传**)</label>
        <input type="file" id="coverFile" accept="image/*" class="file-input">
        
        <div id="metadataDisplay" class="metadata-section" style="display: none;">
            <strong>读取到的元数据：</strong>
            <label for="titleInput">歌曲名 (Title):</label>
            <input type="text" id="titleInput" placeholder="自动读取或手动输入">
            
            <label for="artistInput">艺术家 (Artist):</label>
            <input type="text" id="artistInput" placeholder="自动读取或手动输入">
            
            <label for="albumInput">专辑 (Album):</label>
            <input type="text" id="albumInput" placeholder="自动读取或手动输入">
        </div>
        
        <button type="submit" id="submitBtn">开始上传音乐文件</button>
        <button type="button" id="submitCoverBtn" disabled>上传封面文件</button>
    </form>
    
    <div id="linkOutput" style="margin-top: 10px; display: none;">
        <strong>播放链接:</strong>
        <a id="musicLink" href="#" target="_blank"></a>
        <button id="copyLinkBtn">复制链接</button>
    </div>
    
    <pre id="message"></pre>

    <button type="button" id="listAssetsBtn" style="background-color: #6c757d; color: white;">显示所有已上传文件</button>
    <div id="assetListDisplay" style="margin-top: 15px; border: 1px solid #ddd; display: none;"></div>

    <script>
        // ❗ 步骤 1: 替换为你的 MyMusic Worker 实际部署的 URL (注意：移除末尾斜杠)
        const WORKER_URL = 'https://mymusic.mikephiemy.workers.dev'; 
        
        // ❗ 步骤 2: 替换为你的 R2 公共访问域名 (与 Worker 配置的 PUBLIC_BASE 匹配)
        const PUBLIC_BASE_URL = 'https://pub-29d19c8bafe64fa09b3241d38311ba54.r2.dev'; 
        
        const form = document.getElementById('uploadForm');
        const musicFileInput = document.getElementById('musicFile');
        const coverFileInput = document.getElementById('coverFile');
        const submitBtn = document.getElementById('submitBtn');
        const submitCoverBtn = document.getElementById('submitCoverBtn');
        const messageDisplay = document.getElementById('message');
        const metadataDisplay = document.getElementById('metadataDisplay');
        const titleInput = document.getElementById('titleInput');
        const artistInput = document.getElementById('artistInput');
        const albumInput = document.getElementById('albumInput');
        
        const linkOutputDiv = document.getElementById('linkOutput');
        const musicLinkAnchor = document.getElementById('musicLink');
        const copyLinkButton = document.getElementById('copyLinkBtn');
        
        const listAssetsBtn = document.getElementById('listAssetsBtn'); 
        const assetListDisplay = document.getElementById('assetListDisplay'); 
        
        let lastMusicKey = ''; 

        // --- 元数据读取逻辑 ---
        musicFileInput.addEventListener('change', async () => {
            const file = musicFileInput.files[0];
            if (!file) return;

            metadataDisplay.style.display = 'block';
            titleInput.value = '正在读取...';
            artistInput.value = '';
            albumInput.value = '';
            
            if (typeof jsmediatags === 'undefined') {
                titleInput.value = '无法读取元数据，请手动输入。';
                return;
            }

            jsmediatags.read(file, {
                onSuccess: function(tag) {
                    titleInput.value = tag.tags.title || '';
                    artistInput.value = tag.tags.artist || '';
                    albumInput.value = tag.tags.album || '';
                },
                onError: function() {
                    titleInput.value = file.name;
                    artistInput.value = '';
                    albumInput.value = '(读取失败)';
                }
            });
        });


        // --- 通用上传函数 ---
        async function uploadFile(file, customKey, isCover=false) {
            const formData = new FormData();
            formData.append('file', file);
            
            if (customKey) {
                 formData.append('key', customKey); 
            }
            
            if (!isCover) {
                formData.append('title', titleInput.value);
                formData.append('artist', artistInput.value);
                formData.append('album', albumInput.value);
            }

            const response = await fetch(WORKER_URL, {
                method: 'POST',
                body: formData,
            });

            const result = await response.json();
            return { response, result };
        }

        // --- 1. 上传音乐文件 ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            messageDisplay.textContent = '开始上传音乐文件...';
            linkOutputDiv.style.display = 'none'; 
            submitBtn.disabled = true;
            submitCoverBtn.disabled = true;

            const musicFile = musicFileInput.files[0];
            if (!musicFile) {
                messageDisplay.textContent = '错误: 请选择一个音乐文件。';
                submitBtn.disabled = false;
                return;
            }
            
            try {
                const { response, result } = await uploadFile(musicFile, null, false);
                
                if (response.ok) {
                    messageDisplay.textContent += `\n音乐文件上传成功！\n路径: ${result.keyUsed}\n元数据: ${JSON.stringify(result.metadata, null, 2)}`;
                    
                    // 构建并显示播放链接
                    const musicKey = result.keyUsed;
                    const publicUrl = `${PUBLIC_BASE_URL}/${musicKey}`; 

                    musicLinkAnchor.href = publicUrl;
                    musicLinkAnchor.textContent = publicUrl;
                    linkOutputDiv.style.display = 'block';

                    copyLinkButton.onclick = function() {
                        navigator.clipboard.writeText(publicUrl).then(() => {
                            alert('播放链接已复制到剪贴板！');
                        }, (err) => {
                            console.error('无法复制链接: ', err);
                            alert('复制失败，请手动复制。');
                        });
                    };

                    lastMusicKey = result.keyUsed;
                    if (coverFileInput.files[0]) {
                        submitCoverBtn.disabled = false;
                        messageDisplay.textContent += '\n\n✅ 音乐文件已就绪。请点击 "上传封面文件" 按钮上传封面。';
                    }
                } else {
                    messageDisplay.textContent += `\n上传失败！\n错误信息: ${result.error}`;
                }

            } catch (error) {
                messageDisplay.textContent += `\n网络/未知错误: ${error.message}`;
            } finally {
                submitBtn.disabled = false;
            }
        });

        // --- 2. 上传封面文件 ---
        submitCoverBtn.addEventListener('click', async () => {
            const coverFile = coverFileInput.files[0];
            if (!coverFile || !lastMusicKey) {
                messageDisplay.textContent += '\n错误：没有选择封面文件或音乐文件尚未上传。';
                return;
            }
            
            submitCoverBtn.disabled = true;
            messageDisplay.textContent += '\n\n开始上传封面文件...';
            
            try {
                const ext = coverFile.name.substring(coverFile.name.lastIndexOf('.'));
                const baseName = lastMusicKey.replace(/^(audio|covers)\//, '').substring(0, lastMusicKey.lastIndexOf('.'));
                const coverKey = `${baseName}${ext}`;

                const { response, result } = await uploadFile(coverFile, coverKey, true);
                
                if (response.ok) {
                    messageDisplay.textContent += `\n封面上传成功！\n路径: ${result.keyUsed}`;
                } else {
                    messageDisplay.textContent += `\n封面上传失败！\n错误信息: ${result.error}`;
                }
            } catch (error) {
                messageDisplay.textContent += `\n网络/未知错误: ${error.message}`;
            } finally {
                submitCoverBtn.disabled = false;
                lastMusicKey = '';
            }
        });


        // --- 3. 获取并显示文件列表 (已修正为带按钮) ---
        async function fetchAndDisplayAssets() {
            assetListDisplay.innerHTML = '正在加载资产列表...';
            assetListDisplay.style.display = 'block';
            listAssetsBtn.disabled = true;

            try {
                const response = await fetch(`${WORKER_URL}?action=list`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();

                if (response.ok && data.assets) {
                    
                    let htmlContent = `
                        <p><b>总数:</b> ${data.count} (更新于: ${new Date(data.updatedAt).toLocaleTimeString()})</p>
                        <hr style="border-top: 1px solid #ccc;">
                    `;
                    
                    data.assets.forEach((asset, index) => {
                        const copyId = `copy-btn-${index}`;
                        
                        htmlContent += `
                            <div style="margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px;">
                                <b>类型:</b> ${asset.type || 'unknown'}<br>
                                <b>名称:</b> ${asset.name}<br>
                                <b>URL:</b> <a href="${asset.url}" target="_blank" style="word-break: break-all;">${asset.url}</a>
                                <button id="${copyId}" 
                                        style="background-color: #28a745; color: white; padding: 5px 10px; margin-top: 5px; margin-left: 10px;">
                                    复制链接
                                </button>
                            </div>
                        `;
                    });
                    
                    assetListDisplay.innerHTML = htmlContent;

                    // ❗ 为所有动态创建的按钮绑定复制事件
                    data.assets.forEach((asset, index) => {
                        const copyId = `copy-btn-${index}`;
                        const button = document.getElementById(copyId);
                        if (button) {
                            button.onclick = function() {
                                navigator.clipboard.writeText(asset.url).then(() => {
                                    button.textContent = '已复制!';
                                    setTimeout(() => { button.textContent = '复制链接'; }, 1000);
                                }, (err) => {
                                    console.error('无法复制链接: ', err);
                                    alert('复制失败，请手动复制。');
                                });
                            };
                        }
                    });

                } else {
                    assetListDisplay.textContent = `加载失败: ${data.error || 'Worker 返回错误。'}`;
                }

            } catch (e) {
                assetListDisplay.textContent = `网络错误或解析失败: ${e.message}`;
            } finally {
                listAssetsBtn.disabled = false;
            }
        }

        // --- 绑定按钮事件 ---
        listAssetsBtn.addEventListener('click', fetchAndDisplayAssets);
    </script>
</body>
</html>
